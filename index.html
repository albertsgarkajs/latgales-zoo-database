<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby6CabeU4XKY5WNiLFrd_IqPSugfeee8hQbc6elAcqIgqK3IWTc5AgW-8VqOF6Z1hSiWA/exec';

  function handleCredentialResponse(response) {
    console.log('Google OAuth initiated:', response);
    if (response.credential) {
      // Send the ID token to the backend for verification
      fetch('/api/auth/callback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id_token: response.credential })
      })
        .then(async (res) => {
          if (res.ok) {
            console.log('OAuth callback successful, reloading page');
            window.location.reload(); // Reload to check authentication status
          } else {
            const errorData = await res.json();
            console.error('OAuth callback failed:', errorData);
            document.getElementById('errorMessage').textContent = `Kļūda: ${errorData.error || 'Neizdevās pierakstīties'}`;
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('hidden');
          }
        })
        .catch((error) => {
          console.error('Error during OAuth callback:', error.message);
          document.getElementById('errorMessage').textContent = `Kļūda: ${error.message}`;
          document.getElementById('loginContainer').classList.remove('hidden');
          document.getElementById('loadingOverlay').classList.add('hidden');
        });
    } else {
      console.error('No credential in Google response');
      document.getElementById('errorMessage').textContent = 'Kļūda: Nav derīgu Google autentifikācijas datu';
      document.getElementById('loginContainer').classList.remove('hidden');
      document.getElementById('loadingOverlay').classList.add('hidden');
    }
  }

  window.onload = async () => {
    console.log('Checking authentication status');
    try {
      const urlParams = new URLSearchParams(window.location.search);
      const error = urlParams.get('error');
      if (error) {
        console.log('URL error parameter:', error);
        document.getElementById('errorMessage').textContent = `Kļūda: ${decodeURIComponent(error)}`;
        window.history.replaceState({}, document.title, '/');
        document.getElementById('loginContainer').classList.remove('hidden');
        document.getElementById('loadingOverlay').classList.add('hidden');
        setTimeout(() => {
          document.getElementById('loadingOverlay').style.display = 'none';
        }, 500);
        return;
      }

      const response = await fetch('/api/auth/check', {
        method: 'GET',
        credentials: 'include'
      });
      console.log('Auth check response status:', response.status);
      if (response.status === 404) {
        throw new Error('Authentication endpoint not found. Please contact the administrator.');
      }
      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        const text = await response.text();
        throw new Error(`Invalid response from /api/auth/check: ${text}`);
      }
      const data = await response.json();
      console.log('Auth check response data:', data);
      if (data.error) {
        console.log('Server returned error:', data.error);
        document.getElementById('errorMessage').textContent = `Kļūda: ${data.error}`;
        document.getElementById('loginContainer').classList.remove('hidden');
        document.getElementById('loadingOverlay').classList.add('hidden');
        setTimeout(() => {
          document.getElementById('loadingOverlay').style.display = 'none';
        }, 500);
        return;
      }
      if (data.isAuthenticated) {
        console.log('User is authenticated, showing iframe');
        document.getElementById('loginContainer').classList.add('hidden');
        document.getElementById('appIframe').style.display = 'block';
        document.getElementById('loadingOverlay').classList.add('hidden');
        setTimeout(() => {
          document.getElementById('loadingOverlay').style.display = 'none';
        }, 500);
      } else {
        console.log('User is not authenticated, showing login container');
        document.getElementById('loginContainer').classList.remove('hidden');
        document.getElementById('loadingOverlay').classList.add('hidden');
        setTimeout(() => {
          document.getElementById('loadingOverlay').style.display = 'none';
        }, 500);
      }
    } catch (error) {
      console.error('Error checking auth:', error.message);
      document.getElementById('errorMessage').textContent = `Kļūda pārbaudot autentifikāciju: ${error.message}`;
      document.getElementById('loginContainer').classList.remove('hidden');
      document.getElementById('loadingOverlay').classList.add('hidden');
      setTimeout(() => {
        document.getElementById('loadingOverlay').style.display = 'none';
      }, 500);
    }

    const iframe = document.getElementById('appIframe');
    iframe.onload = () => {
      console.log('Iframe loaded successfully');
      if (document.getElementById('appIframe').style.display === 'block') {
        document.getElementById('loadingOverlay').classList.add('hidden');
        setTimeout(() => {
          document.getElementById('loadingOverlay').style.display = 'none';
        }, 500);
      }
    };
    iframe.onerror = () => {
      console.error('Iframe failed to load');
      document.getElementById('errorMessage').textContent = 'Kļūda ielādējot lietojumprogrammu. Lūdzu, mēģiniet vēlreiz.';
      document.getElementById('loginContainer').classList.remove('hidden');
      document.getElementById('loadingOverlay').classList.add('hidden');
      setTimeout(() => {
        document.getElementById('loadingOverlay').style.display = 'none';
      }, 500);
    };
    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://script.google.com') return;
      if (event.data.action === 'signOut') {
        console.log('Received signOut message from iframe');
        signOut();
      }
    });
  };

  async function signOut() {
    try {
      console.log('Initiating sign-out');
      await fetch('/api/auth/signout', {
        method: 'POST',
        credentials: 'include'
      });
      window.location.reload();
    } catch (error) {
      console.error('Sign-out error:', error.message);
      document.getElementById('errorMessage').textContent = `Kļūda izrakstoties: ${error.message}`;
    }
  }
</script>
